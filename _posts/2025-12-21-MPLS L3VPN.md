---
title: "MPLS L3VPN - RD, RT, VPN Label"
date: 2025-12-21
categories: Network
math: true
---



MPLS L3VPN最重要的3个概念，RD，RT，VPN Label

![img](https://raw.githubusercontent.com/LiuMaoDou/Files/main/Pics/v2-4a0ae11ff33e5acd3fcdd60296fb2a77_1440w.jpg)

RD，RT，VPN Label

## 配置示列

```powershell
#
ip vpn-instance vpna
 ipv4-family
  route-distinguisher 200:1 # RD配置
  apply-label per-instance # VPN Label配置
  vpn-target 111:1 export-extcommunity # RT export配置
  vpn-target 111:1 import-extcommunity # RT import配置
#
```

## RD (Route Distinguisher)

![img](https://raw.githubusercontent.com/LiuMaoDou/Files/main/Pics/v2-dab8921ba4f18862f2c956db2c30320f_1440w.jpg)

RD（Route Distinguisher）

![img](https://raw.githubusercontent.com/LiuMaoDou/Files/main/Pics/v2-7ab8279477bdad55765bb899cd2d2797_1440w.jpg)

VPN-IPv4地址结构 - 12 字节

网络中有多个客户，并且客户的`IP Prefix`都相同时，网络侧会发生地址冲突

![img](https://raw.githubusercontent.com/LiuMaoDou/Files/main/Pics/v2-118ec27f98a2ac99fead837e275a0f91_1440w.jpg)

普通IP Prefix

为了解决这个问题，引入RD的概念，通过 `RD + IP Prefix = VPNv4 Prefix` ，生成**唯一的路由前缀**在MPLS网络中传播。这样MPLS网络可以承载多个不同的客户，并且这些客户的地址可以重叠。

![img](https://raw.githubusercontent.com/LiuMaoDou/Files/main/Pics/v2-d7051d8ac9a9bfd4a45ce63744e83664_1440w.jpg)

VPNv4 Prefix

- An RD is a 64-bit field used to make the [VRF](https://zhida.zhihu.com/search?content_id=235358809&content_type=Article&match_order=1&q=VRF&zhida_source=entity) prefixes unique when MP-BGP carries them.
- The RD does not indicate which VRF the prefix belongs to.
- Each VRF instance on the PE router must have one RD assigned to it. 并且一个VRF里面的RD只能配置一个。
- RD的格式：ASN:nn or IP-address:nn
  - ASN:nn --> 65535:100 (AS号：ID）
  - IP-address:nn --> 192.168.1.1:100 (loopack0：ID）

网络中针对同一个客户，不同的PE尽量配置不同的RD，因为RD相同会造成RR只优选一条VPNv4路由，无法形成[FRR保护](https://zhida.zhihu.com/search?content_id=235358809&content_type=Article&match_order=1&q=FRR保护&zhida_source=entity)。

![img](https://raw.githubusercontent.com/LiuMaoDou/Files/main/Pics/v2-1277ac2214ad5d06bd0d6bf31dda1a6e_1440w.jpg)

RD配置一样，只优选最优的一条

![img](https://raw.githubusercontent.com/LiuMaoDou/Files/main/Pics/v2-23ac5b729a8ff5f4d6745060e122d54f_1440w.jpg)

RD配置不一样，都可以优选发布

## RTs (Route Targets)

![img](https://raw.githubusercontent.com/LiuMaoDou/Files/main/Pics/v2-932982b8beb16413c1c242b5fd048ec0_1440w.jpg)

RTs

BGP/MPLS IP VPN使用64位的[BGP扩展团体属性](https://zhida.zhihu.com/search?content_id=235358809&content_type=Article&match_order=1&q=BGP扩展团体属性&zhida_source=entity)－VPN Target来控制VPN路由信息的发布。

每个VPN实例关联一个或多个VPN Target属性。有两类VPN Target属性：

- Export Target（ERT）：本地PE从直接相连Site学到IPv4路由后，转换为VPN-IPv4路由，并为这些路由设置Export Target属性。Export Target属性作为BGP的扩展团体属性随路由发布。
- Import Target（IRT）：PE收到其它PE发布的VPN-IPv4路由时，检查其Export Target属性。当此属性与PE上某个VPN实例的Import Target匹配时，PE就把路由加入到该VPN实例的路由表。
- 一个VRF里面的RT可以配置多个。

站点之间是否能够通信，由RT来控制。如下图，PE1可以和PE3通信，因为PE1的import和PE3的export RT一样，反之亦然，但是PE2没有跟PE3对齐，所以PE2无法跟PE3通信。

![img](https://raw.githubusercontent.com/LiuMaoDou/Files/main/Pics/v2-496a58e27129fe3b29aeaf1d0e7af53f_1440w.jpg)

RT控制通信

使用VPN Target而不直接用RD作为BGP扩展团体属性的原因在于：

- 一条VPN-IPv4路由只能有一个RD，但可以关联多个VPN Target属性；BGP如果携带多个扩展团体属性，可以提高网络的灵活性和可扩展性。
- VPN Target用于控制同一PE上不同VPN之间的路由发布。即，同一PE上的不同VPN之间可以设置匹配的VPN Target来实现路由的互相引入。

## VPN Label

![img](https://raw.githubusercontent.com/LiuMaoDou/Files/main/Pics/v2-cb1ef34878060855120704cfd466c85b_1440w.jpg)

VPN Label

路由器C有2个VRF，VRF地址都一样的。如果RouterA要访问VRF1的192.168.1.1，RouterB要访问VRF2的192.168.1.1，两个流量到达RouterC时候，RouterC无法判断应该转发给哪个VRF。

![img](https://raw.githubusercontent.com/LiuMaoDou/Files/main/Pics/v2-ee7d669c86ee208151de5ef96c72c620_1440w.jpg)

VPN Label

如果RouterC给每一个VRF分配一个标签发送给远端设备，远端设备发送报文的时候携带这个标签，这样RouterC收到流量后就能先判断这个流量属于哪个VRF，然后在这个VRF查路由表转发。

默认情况，每个VRF每个路由会单独分配一个标签，可以配置给整个VRF里面的所有路由分配一个标签，但是不同的VRF标签必须不一样（才能区分VRF）

![img](https://raw.githubusercontent.com/LiuMaoDou/Files/main/Pics/v2-85b098b1351fb16609dbe9a166be7794_1440w.jpg)

VPN Label分配

## MPLS VPN路由传递过程

![img](https://raw.githubusercontent.com/LiuMaoDou/Files/main/Pics/v2-8fff2e3d1786192fbff2e0120789ad19_1440w.jpg)

控制面交互 1-3

![img](https://raw.githubusercontent.com/LiuMaoDou/Files/main/Pics/v2-645a494d7331933e9f3a63a66f3752f7_1440w.jpg)

控制面交互 4-5

![img](https://raw.githubusercontent.com/LiuMaoDou/Files/main/Pics/v2-51cbe11adcf81e227ec30a54fba941b5_1440w.jpg)

Route Propagation in an MPLS VPN Network Step by Step

## MPLS VPN流量转发过程

![img](https://raw.githubusercontent.com/LiuMaoDou/Files/main/Pics/v2-4de281bb037267dcbfe25e79365979ce_1440w.jpg)

流量转发过程

![img](https://raw.githubusercontent.com/LiuMaoDou/Files/main/Pics/v2-33f06f81f334f502701853ad2be22b07_1440w.jpg)

抓包

![img](https://raw.githubusercontent.com/LiuMaoDou/Files/main/Pics/v2-2e512db7b6ce5619b70e89af3d1fd392_1440w.jpg)

Packet Forwarding in an MPLS VPN Network

## 参考资料

1. 《MPLS Fundamentals》- Cisco Book
2. 《MPLS and VPN Architectures》- Cisco Book
3. BRKMPL-2102 - Designing IP VPNs MPLS with/out Segment Routing - Cisco Live
4. 《BGP/MPLS IP VPN原理描述》- 华为
